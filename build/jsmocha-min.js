var jsMocha={};
jsMocha.Cardinality=new (function(){function a(b,c){this.required=b;this.maximum=c;this.verify=function(d){return d>=this.required&&d<=this.maximum?true:false};this.allowed_any_number_of_times=function(){return this.required===0&&this.maximum==Infinity?true:false};this.inspect=function(){if(this.allowed_any_number_of_times())return"allowed any number of times";else if(this.required===0&&this.maximum===0)return"expected never";else if(this.required==this.maximum)return"expected exactly "+this.times(this.required);
else if(this.maximum==Infinity)return"expected at least "+this.times(this.required);else if(this.required===0)return"expected at most "+this.times(this.maximum)};this.times=function(d){switch(d){case 0:return"no times";case 1:return"once";case 2:return"twice";default:return d+" times"}}}this.exactly=function(b){return new a(b,b)};this.at_least=function(b){return new a(b,Infinity)};this.at_most=function(b){return new a(0,b)}});
jsMocha.Expectation=function(a,b){this.mock=a;this.mock_name=this.get_name(a);this.method_name=b;this.actual_parameters=null;this.replace_method(a,b);this.cardinality=jsMocha.Cardinality.exactly(1);this.invocation_count=0;this.local_report=[];this.return_values=null;this.valid=true};
jsMocha.Expectation.prototype={times:function(a){this.cardinality=jsMocha.Cardinality.exactly(a);return this},once:function(){this.cardinality=jsMocha.Cardinality.exactly(1);return this},twice:function(){this.cardinality=jsMocha.Cardinality.exactly(2);return this},never:function(){this.cardinality=jsMocha.Cardinality.exactly(0);return this},at_least:function(a){this.cardinality=jsMocha.Cardinality.at_least(a);return this},at_most:function(a){this.cardinality=jsMocha.Cardinality.at_most(a);return this},
passing:function(){this.parameters_matcher=new jsMocha.ParametersMatcher(arguments);return this},returns:function(){this.return_values=arguments;return this},replace_method:function(a,b){this.original_method=a[b];var c=this;a[b]=function(){c.invocation_count+=1;c.parameters_matcher&&c.parameters_matcher.match(arguments);if(c.return_values)return c.next_return_value()}},next_return_value:function(){var a=this.return_values.length;if(a==1)return this.return_values[0];else if(a>1){var b=this.invocation_count-
1;return b>a-1?this.return_values[a-1]:this.return_values[b]}},verify:function(){this.valid=true;this.local_report=[];this.add_report("object: "+this.mock_name+"."+this.method_name);if(this.cardinality.verify(this.invocation_count)){this.set_valid(true);this.add_report("PASS "+this.cardinality.inspect()+" invoked "+this.cardinality.times(this.invocation_count))}else{this.set_valid(false);this.add_report("FAIL wrong number of invocations, "+this.cardinality.inspect()+" invoked "+this.cardinality.times(this.invocation_count))}if(this.parameters_matcher){param_report=
this.parameters_matcher.report();if(param_report===true)this.set_valid(true);else{this.set_valid(false);this.add_report("FAIL "+param_report)}}return this.is_valid()},set_valid:function(a){if(this.valid!==false)this.valid=a},is_valid:function(){return this.valid},report:function(){return this.local_report.join("\r\n")},add_report:function(a){this.local_report.push(a)},restore:function(){this.mock[this.method_name]=this.original_method},get_name:function(a){return(a=/function (.{1,})\(/.exec(a.constructor.toString()))&&
a.length>1?a[1]:""}};jsMocha.ExpectationList=function(){this.expectations={}};
jsMocha.ExpectationList.prototype={add:function(a,b){a=new jsMocha.Expectation(a,b);this.find_or_create(b).expectations.push(a);return a},find_or_create:function(a){this.expectations[a]||(this.expectations[a]={expectations:[],original_method:null});return this.expectations[a]},verify_all:function(){var a=[];for(var b in this.expectations)if(this.expectations.hasOwnProperty(b))for(var c=this.expectations[b].expectations.length,d=0;d<c;d++)a.push(this.expectations[b].expectations[d].verify());return this.all_passed(a)},
all_passed:function(a){for(var b=a.length,c=0;c<b;c++)if(a[c]===false)return false;return true},reports:function(){var a=[];for(var b in this.expectations)if(this.expectations.hasOwnProperty(b))for(var c=this.expectations[b].expectations.length,d=0;d<c;d++)a.push(this.expectations[b].expectations[d].report());return"\r\n"+a.join("\r\n")},restore_all:function(){for(var a in this.expectations)if(this.expectations.hasOwnProperty(a))for(var b=this.expectations[a].expectations.length,c=0;c<b;c++)this.expectations[a].expectations[c].restore()}};
Mock=function(a,b){var c=a||{};if(this.already_mocked(c))return c;this.expectations=new jsMocha.ExpectationList;if(this.check_for_clashes(c)&&!b)throw new Error("Cannot mock object, function names clash!!");b=typeof c;a=Object.prototype.toString.call(a);if((b==="function"||b==="object")&&a!=="[object Date]"&&a!=="[object Array]")this.add_methods_to_object(c);else throw new Error("Cannot mock something of type: "+typeof c);this.mock=c;Mock.mocked_objects.push(c);return c};Mock.mocked_objects=[];
Mock.mockerize=function(){Object.prototype.expects=function(a){if(Mock.is_real_call(arguments))return Mock.mock_from_expects(this,a)};Function.prototype.expects=function(a){if(Mock.is_real_call(arguments))return Mock.mock_from_expects(this,a)};Object.prototype.stubs=function(a){if(Mock.is_real_call(arguments))return Mock.mock_from_stubs(this,a)};Function.prototype.stubs=function(a){if(Mock.is_real_call(arguments))return Mock.mock_from_stubs(this,a)}};
Mock.is_real_call=function(a){return a.length==1&&typeof a[0]=="string"};Mock.mock_from_expects=function(a,b){new Mock(a,true);return a.expects(b)};Mock.mock_from_stubs=function(a,b){new Mock(a,true);return a.stubs(b)};Mock.teardown_all=function(){for(var a=Mock.mocked_objects.length,b=0;b<a;b++)typeof Mock.mocked_objects[b].jsmocha!=="undefined"&&Mock.mocked_objects[b].jsmocha.teardown(true);Mock.mocked_objects=[]};
Mock.remove_from_mocked_objects=function(a){for(var b=Mock.mocked_objects.length,c=0;c<b;c++)if(Mock.mocked_objects[c]===a){Mock.mocked_objects.splice(c,1);return}};
Mock.prototype={reservedNames:["expects","stubs","jsmocha"],already_mocked:function(a){return a.jsmocha?true:false},check_for_clashes:function(a){for(property in a)if(this.in_array(property,this.reservedNames))return true},in_array:function(a,b){for(var c=b.length,d=0;d<c;d++)if(a==b[d])return true;return false},add_methods_to_object:function(a){a.jsmocha=this;a.stubs=function(b){b=this.jsmocha.expectations.add(this,b);b.at_least(0);return b};a.expects=function(b){return this.jsmocha.expectations.add(this,
b)}},verify:function(){return this.expectations.verify_all()},report:function(){var a=this.expectations.reports();this.teardown();return a},teardown:function(a){a||Mock.remove_from_mocked_objects(this.mock);this.expectations.restore_all();delete this.mock.expects;delete this.mock.stubs;delete this.mock.jsmocha}};jsMocha.ParametersMatcher=function(a){this.expected_parameters=a;this.serialize_stack_limit=4;this.invocations=[]};
jsMocha.ParametersMatcher.prototype={valid:function(){for(var a=this.invocations.length,b=0;b<a;b++)if(this.invocations[b]===false)return false;return true},match:function(a){this.actual_parameters=a;if(this.block_given()){this.invocations.push(this.block(a));return this.valid()}else return this.parameters_match(a)},parameters_match:function(a){for(var b=this.expected_parameters.length,c=0;c<=b;c++)if(a[c]!=this.expected_parameters[c]){this.invocations.push(false);return false}this.invocations.push(true);
return true},block_given:function(){if(this.expected_parameters.length==1&&this.is_function(this.expected_parameters[0])){this.block=this.expected_parameters[0];return true}else return false},is_function:function(a){return typeof a=="function"||Object.prototype.toString.call(a)=="[object Function]"?true:false},report:function(){if(this.valid())return true;else{var a="";if(this.block_given())a+="received (";else{a+="expected (";a+=this.list_parameters(this.expected_parameters);a+=") but got ("}a+=
this.list_parameters(this.actual_parameters);a+=")";return a}},list_parameters:function(a){if(a){for(var b=[],c=a.length,d=0;d<c;d++)b.push(this.serialize(a[d],0));return b.join(", ")}},serialize:function(a,b){if(b>this.serialize_stack_limit)return"object too complex to fully display";if(a===null)return"null";switch(typeof a){case "number":case "boolean":case "function":return a;case "string":return'"'+a+'"';case "object":if(typeof a.toSource!=="undefined"&&typeof a.callee==="undefined"){a=a.toSource();
return a.substring(1,a.length-1)}else{var c=[];if(a.constructor===Array||typeof a.callee!=="undefined"){for(var d=a.length-1,e=0;e<d;e++)c.push(this.serialize(a[e],b+1));c.push(this.serialize(a[e],b+1));a="["+c.join(", ")+"]"}else{for(d in a)a.hasOwnProperty(d)&&c.push(d+":"+this.serialize(a[d],b+1));a="{"+c.join(", ").replace(/\,$/,"")+"}"}return a}default:return"UNKNOWN"}}};
