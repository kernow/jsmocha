var jsMocha={};
jsMocha.Cardinality=new (function(){function a(b,c){this.required=b;this.maximum=c;this.verify=function(d){return d>=this.required&&d<=this.maximum?true:false};this.allowed_any_number_of_times=function(){return this.required===0&&this.maximum==Infinity?true:false};this.inspect=function(){if(this.allowed_any_number_of_times())return"allowed any number of times";else if(this.required===0&&this.maximum===0)return"expected never";else if(this.required==this.maximum)return"expected exactly "+this.times(this.required);
else if(this.maximum==Infinity)return"expected at least "+this.times(this.required);else if(this.required===0)return"expected at most "+this.times(this.maximum)};this.times=function(d){switch(d){case 0:return"no times";case 1:return"once";case 2:return"twice";default:return d+" times"}}}this.exactly=function(b){return new a(b,b)};this.at_least=function(b){return new a(b,Infinity)};this.at_most=function(b){return new a(0,b)}});
jsMocha.console={log:function(a){typeof window.console!="undefined"&&console.log(a)},warn:function(a){typeof window.console!="undefined"&&console.log(a)}};
jsMocha.Expectation=function(a,b){this.mock=a;if(a=this.existing_expecation(b)){jsMocha.console.log("ARRRRRG, trying you mock twice you be!");a.has_existing_expectation=true;a.once();return a}else{this.has_existing_expectation=false;this.once()}this.method_name=b;this.actual_parameters=null;this.invocation_count=0;this.local_report=[];this.return_values=null;this.valid=true;this.callback=null;this.callback_arguments=[]};
jsMocha.Expectation.prototype={times:function(a){this.cardinality=jsMocha.Cardinality.exactly(a);return this},once:function(){this.cardinality=this.has_existing_expectation?jsMocha.Cardinality.exactly(this.cardinality.maximum+1):jsMocha.Cardinality.exactly(1);return this},twice:function(){this.cardinality=jsMocha.Cardinality.exactly(2);return this},never:function(){this.cardinality=jsMocha.Cardinality.exactly(0);return this},at_least:function(a){this.cardinality=jsMocha.Cardinality.at_least(a);return this},
at_most:function(a){this.cardinality=jsMocha.Cardinality.at_most(a);return this},passing:function(){this.parameters_matcher=new jsMocha.ParametersMatcher(arguments);return this},returns:function(){this.return_values=arguments;return this},runs:function(a){this.callback=a;return this},invokes_arguments:function(){this.callback_arguments=arguments;return this},should_return_something:function(){return this.return_values?true:false},existing_expecation:function(a){if(this.mock.jsmocha)for(var b=this.mock.jsmocha.expectations.expectations.length,
c=0;c<b;c++)if(this.mock.jsmocha.expectations.expectations[c].method_name==a)return this.mock.jsmocha.expectations.expectations[c]},match:function(a){if(this.parameters_matcher)if(this.parameters_matcher.match(a)){this.invocation_count+=1;return true}else return false;else{this.invocation_count+=1;return true}},next_return_value:function(){var a=this.return_values.length;if(a==1)return this.return_values[0];else if(a>1){var b=this.invocation_count-1;return b>a-1?this.return_values[a-1]:this.return_values[b]}},
run_callbacks:function(a){this.callback&&this.callback();for(var b=this.callback_arguments.length,c=0;c<b;c++)a[this.callback_arguments[c]]()},verify:function(){this.valid=true;this.local_report=[];if(this.cardinality.verify(this.invocation_count)){this.set_valid(true);this.add_report("PASS "+this.cardinality.inspect()+this.expected_params_report()+" invoked "+this.cardinality.times(this.invocation_count))}else{this.set_valid(false);this.add_report("FAIL wrong number of invocations, "+this.cardinality.inspect()+
this.expected_params_report()+" invoked "+this.cardinality.times(this.invocation_count))}if(this.parameters_matcher){param_report=this.parameters_matcher.report();if(param_report===true)this.set_valid(true);else{this.set_valid(false);this.add_report("FAIL "+param_report)}}return this.is_valid()},expected_params_report:function(){return this.parameters_matcher?" with("+this.parameters_matcher.list_parameters(this.parameters_matcher.expected_parameters)+")":""},set_valid:function(a){if(this.valid!==
false)this.valid=a},is_valid:function(){return this.valid},report:function(){return this.local_report.join("\r\n")},add_report:function(a){this.local_report.push(a)}};jsMocha.ExpectationList=function(){this.expectations={}};
jsMocha.ExpectationList.prototype={add:function(a,b,c){c=c||{type:"mock"};var d=new jsMocha.Expectation(a,b),e=this.find_or_create(b);this.store_local_expectation(e,d,c);this.store_mocked_object(e,a);this.replace_method(a,b,e,c);return d},find_or_create:function(a){this.expectations[a]||(this.expectations[a]={expectations:{mock:[],spy:[],stub:[]},obj:null,original_method:null,invocation_count:0});return this.expectations[a]},store_local_expectation:function(a,b,c){a.expectations[c.type].push(b)},
store_mocked_object:function(a,b){if(a.obj===null)a.obj=b},replace_method:function(a,b,c,d){var e=this;if(c.original_method===null)c.original_method=a[b];a[b]=function(){jsMocha.console.log("JSMOCHA INFO: method invoked with the parameters:");jsMocha.console.log(arguments);c.invocation_count+=1;var f=e.check_for_matches(c.expectations.mock,arguments);if(f===false)f=e.check_for_matches(c.expectations.spy,arguments);if(f===false)f=e.check_for_matches(c.expectations.stub,arguments);if(f!==false&&f.should_return_something())return f.next_return_value();
d.type=="spy"&&c.original_method.apply(a,arguments)}},check_for_matches:function(a,b){for(var c=a.length,d=0;d<c;d++)if(a[d].match(b)){a[d].run_callbacks(b);return a[d]}return false},verify_all:function(){var a=[];for(var b in this.expectations)if(this.expectations.hasOwnProperty(b)){jsMocha.console.log("JSMOCHA INFO: total invocations: "+this.expectations[b].invocation_count);a=this.verify_each(this.expectations[b].expectations.mock,a);a=this.verify_each(this.expectations[b].expectations.spy,a);
a=this.verify_each(this.expectations[b].expectations.stub,a)}return this.all_passed(a)},verify_each:function(a,b){for(var c=a.length,d=0;d<c;d++)b.push(a[d].verify());return b},all_passed:function(a){for(var b=a.length,c=0;c<b;c++)if(a[c]===false)return false;return true},reports:function(){var a=[];for(var b in this.expectations)if(this.expectations.hasOwnProperty(b)){a.push("object: "+this.get_name(this.expectations[b].obj)+"."+b);a.push("INFO called "+this.expectations[b].invocation_count+" time(s)");
a=this.reports_for_each(this.expectations[b].expectations.mock,a);a=this.reports_for_each(this.expectations[b].expectations.spy,a);a=this.reports_for_each(this.expectations[b].expectations.stub,a)}return"\r\n"+a.join("\r\n")},reports_for_each:function(a,b){for(var c=a.length,d=0;d<c;d++)b.push(a[d].report());return b},restore_all:function(){for(var a in this.expectations)this.expectations.hasOwnProperty(a)&&this.restore(a,this.expectations[a])},restore:function(a,b){b.obj[a]=b.original_method},get_name:function(a){return(a=
/function (.{1,})\(/.exec(a.constructor.toString()))&&a.length>1?a[1]:""}};
var Match={is_a_method_of:function(a){for(meth in Match)if(a===Match[meth])return true},a_string:function(a){return typeof a===Match.STRING},an_array:function(a){return Match.type(a)===Match.ARRAY},a_boolean:function(a){return typeof a===Match.BOOLEAN},a_function:function(a){return Match.type(a)===Match.FUNCTION},a_date:function(a){return Match.type(a)===Match.DATE},is_null:function(a){return a===null},a_number:function(a){return typeof a===Match.NUMBER&&isFinite(a)},an_object:function(a,b){return a&&
(typeof a===Match.OBJECT||!b&&Match.a_function(a))||false},is_undefined:function(a){return typeof a===Match.UNDEFINED},type:function(a){jsMocha.console.warn();jsMocha.console.warn(Match.TYPES[typeof a]);jsMocha.console.warn(Match.TYPES[Match.TOSTRING.call(a)]);return Match.TYPES[typeof a]||Match.TYPES[Match.TOSTRING.call(a)]||(a?Match.OBJECT:Match.NULL)}};Match.ARRAY="array";Match.BOOLEAN="boolean";Match.DATE="date";Match.ERROR="error";Match.FUNCTION="function";Match.NUMBER="number";Match.NULL="null";
Match.OBJECT="object";Match.REGEX="regexp";Match.STRING="string";Match.TOSTRING=Object.prototype.toString;Match.UNDEFINED="undefined";Match.TYPES={undefined:Match.UNDEFINED,number:Match.NUMBER,"boolean":Match.BOOLEAN,string:Match.STRING,"[object Function]":Match.FUNCTION,"[object RegExp]":Match.REGEX,"[object Array]":Match.ARRAY,"[object Date]":Match.DATE,"[object Error]":Match.ERROR};
Mock=function(a,b){var c=a||{};if(this.already_mocked(c))return c;this.expectations=new jsMocha.ExpectationList;if(this.check_for_clashes(c)&&!b)throw new Error("Cannot mock object, function names clash!!");b=typeof c;a=Object.prototype.toString.call(a);if((b==="function"||b==="object")&&a!=="[object Date]"&&a!=="[object Array]")this.add_methods_to_object(c);else throw new Error("Cannot mock something of type: "+typeof c);this.mock=c;Mock.mocked_objects.push(c);return c};Mock.mocked_objects=[];
Mock.mockerize=function(){Object.prototype.expects=function(a){if(Mock.is_real_call(arguments))return Mock.mock_from_expects(this,a)};Function.prototype.expects=function(a){if(Mock.is_real_call(arguments))return Mock.mock_from_expects(this,a)};Object.prototype.stubs=function(a){if(Mock.is_real_call(arguments))return Mock.mock_from_stubs(this,a)};Function.prototype.stubs=function(a){if(Mock.is_real_call(arguments))return Mock.mock_from_stubs(this,a)};Object.prototype.spies=function(a){if(Mock.is_real_call(arguments))return Mock.mock_from_spies(this,
a)};Function.prototype.spies=function(a){if(Mock.is_real_call(arguments))return Mock.mock_from_spies(this,a)}};Mock.is_real_call=function(a){return a.length==1&&typeof a[0]=="string"};Mock.mock_from_expects=function(a,b){new Mock(a,true);return a.expects(b)};Mock.mock_from_stubs=function(a,b){new Mock(a,true);return a.stubs(b)};Mock.mock_from_spies=function(a,b){new Mock(a,true);return a.spies(b)};
Mock.teardown_all=function(){for(var a=Mock.mocked_objects.length,b=0;b<a;b++)typeof Mock.mocked_objects[b].jsmocha!=="undefined"&&Mock.mocked_objects[b].jsmocha.teardown(true);Mock.mocked_objects=[]};Mock.remove_from_mocked_objects=function(a){for(var b=Mock.mocked_objects.length,c=0;c<b;c++)if(Mock.mocked_objects[c]===a){Mock.mocked_objects.splice(c,1);return}};
Mock.prototype={reservedNames:["expects","stubs","spies","jsmocha"],already_mocked:function(a){return a.jsmocha?true:false},check_for_clashes:function(a){for(property in a)if(this.in_array(property,this.reservedNames))return true},in_array:function(a,b){for(var c=b.length,d=0;d<c;d++)if(a==b[d])return true;return false},add_methods_to_object:function(a){a.jsmocha=this;a.stubs=function(b){b=this.jsmocha.expectations.add(this,b,{type:"stub"});b.at_least(0);return b};a.expects=function(b){return this.jsmocha.expectations.add(this,
b)};a.spies=function(b){return this.jsmocha.expectations.add(this,b,{type:"spy"})}},verify:function(){return this.expectations.verify_all()},report:function(){var a=this.expectations.reports();this.teardown();return a},teardown:function(a){a||Mock.remove_from_mocked_objects(this.mock);this.expectations.restore_all();delete this.mock.expects;delete this.mock.stubs;delete this.mock.spies;delete this.mock.jsmocha}};
jsMocha.ParametersMatcher=function(a){this.expected_parameters=a;this.serialize_stack_limit=4;this.invocations=[]};
jsMocha.ParametersMatcher.prototype={valid:function(){var a=this.invocations.length;if(a<1)return false;for(var b=0;b<a;b++)if(this.invocations[b]===false)return false;return true},match:function(a){this.actual_parameters=a;if(this.block_given())if(this.block(a)){this.invocations.push(true);return true}else return false;else return this.parameters_match(a)},parameters_match:function(a){for(var b=this.expected_parameters.length,c=0;c<=b;c++)if(Match.is_a_method_of(this.expected_parameters[c])){jsMocha.console.warn("not running regular matcher");
if(!this.expected_parameters[c](a[c]))return false}else if(!this.equal(this.expected_parameters[c],a[c]))return false;this.invocations.push(true);return true},equal:function(a,b,c){c=c||0;if(c>this.serialize_stack_limit){jsMocha.console.warn("object too complex to fully match");return true}jsMocha.console.warn("running regular matcher");if(a instanceof Array){for(var d=0;d<b.length;d++)if(!this.equal(a[d],b[d],c+1))return false;return b.length==a.length}else if(Object.prototype.toString.call(a)==
"[object Date]")return a.valueOf()==b.valueOf();else if(a instanceof Object){for(d in a)if(b[d]!==undefined)if(d!="expects"&&d!="spies"&&d!="stubs"&&d){if(!this.equal(a[d],b[d],c+1))return false}else return true;else return false;for(d in b)if(a[d]!==undefined){if(!this.equal(a[d],b[d],c+1))return false}else return false;return true}else return a==b},block_given:function(){if(this.expected_parameters.length==1&&this.is_function(this.expected_parameters[0])&&!Match.is_a_method_of(this.expected_parameters[0])){this.block=
this.expected_parameters[0];return true}else return false},is_function:function(a){return typeof a=="function"||Object.prototype.toString.call(a)=="[object Function]"?true:false},report:function(){if(this.valid()||this.invocations.length<1)return true;else{var a="";if(this.block_given())a+="received (";else{a+="expected (";a+=this.list_parameters(this.expected_parameters);a+=") but got ("}a+=this.list_parameters(this.actual_parameters);a+=")";return a}},list_parameters:function(a){if(a){for(var b=
[],c=a.length,d=0;d<c;d++)b.push(this.serialize(a[d],0));return b.join(", ")}},serialize:function(a,b){if(b>this.serialize_stack_limit)return"object too complex to fully display";if(a===null)return"null";switch(typeof a){case "number":case "boolean":case "function":return a;case "string":return'"'+a+'"';case "object":if(typeof a.toSource!=="undefined"&&typeof a.callee==="undefined"){a=a.toSource();return a.substring(1,a.length-1)}else{var c=[];if(a.constructor===Array||typeof a.callee!=="undefined"){for(var d=
a.length-1,e=0;e<d;e++)c.push(this.serialize(a[e],b+1));c.push(this.serialize(a[e],b+1));a="["+c.join(", ")+"]"}else{for(d in a)a.hasOwnProperty(d)&&c.push(d+":"+this.serialize(a[d],b+1));a="{"+c.join(", ").replace(/\,$/,"")+"}"}return a}default:return"UNKNOWN"}}};
